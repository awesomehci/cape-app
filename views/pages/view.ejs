<!DOCTYPE html>
<html>
<head>
    <% include ../partials/header.ejs %>
</head>

<!-- TODO: change format to 3 column-->
<body>
<script>
    var paper_id = "<%= paper_id %>";
    console.log(paper_id);


    var paperTitle = "";
    var paperOwner = "";
    var paperURL = "";
    var preferences;
    var needs;

    var xhr = new XMLHttpRequest();
    var url = "/api/papers/" + paper_id;
    xhr.open("GET", url, true);

    //Send the proper header information along with the request
    xhr.setRequestHeader("Content-type", "application/json");
    xhr.setRequestHeader("Accept", "application/json");

    xhr.onreadystatechange = function () {//Call a function when the state changes.

        if (xhr.readyState == 4 && xhr.status == 200) {
            var response = JSON.parse(xhr.responseText);
            console.log(response);

            paperTitle = response.title;
            paperOwner = response.owner.fullName;
            paperURL = "http://docs.google.com/gview?url=" + response.url + "&embedded=true";
            preferences = response.preferences;
            needs = response.needs;
            //console.log(preferences);

            document.getElementById('paperTitle').innerHTML = "Title: " + paperTitle;
            document.getElementById('paperOwner').innerHTML = "Owner: " + paperOwner;
            document.getElementById('paperIframe').src = paperURL;
            console.log(paperURL);

            document.getElementById('preferencelist').appendChild(makeUL(preferences));
            document.getElementById('needlist').appendChild(makeUL(needs));
            generate_table(response.proofreaders);

            //Set icons of status cells
            if(document.body.contains(document.getElementById('status_cell_false'))){
                document.getElementById('status_cell_false').innerHTML = ('<i class="material-icons" style="vertical-align: top; font-size:18px">check_box_outline_blank</i>');
            }
            if(document.body.contains(document.getElementById('status_cell_true'))){
                document.getElementById("status_cell_true").innerHTML = ('<i class="material-icons" style="vertical-align: top; font-size:18px">check_box</i>');
            }
        }
    }

    function makeUL(array) {
        // Create the list element:
        var list = document.createElement('ul');

        for (var i = 0; i < array.length; i++) {
            // Create the list item:
            var item = document.createElement('li');
            // Set its contents:
            item.appendChild(document.createTextNode(array[i]));
            // Add it to the list:
            list.appendChild(item);
        }
        // Finally, return the constructed list:
        return list;
    }


    function generate_table(array) {
        var tbl = document.createElement("table");
        tbl.className = "table table-striped";

        var tblBody = document.createElement("tbody");

        //Create header
        var col = ["Status", "Proofreader", "Comments & Edits"];
        var tr = tbl.insertRow(-1);

        for (var i = 0; i < col.length; i++) {
            var th = document.createElement("th");      // TABLE HEADER.
            th.innerHTML = col[i];
            tr.appendChild(th);
        }

        // creating all cells
        for (var i = 0; i < array.length; i++) {
            // creates a table row
            var row = document.createElement("tr");
            var statusCell = document.createElement("td");
            var nameCell = document.createElement("td");
            var urlCell = document.createElement("td");
            var cellText; //holder

            //Setting IDs so that the status symbol will show up
            if (array[i].responded == false) {statusCell.setAttribute("id", "status_cell_false");}
            else {statusCell.setAttribute("id", "status_cell_true");}

            cellText = document.createTextNode(array[i].user.fullName);
            nameCell.appendChild(cellText);

            if (array[i].url == null) {
                var btn = document.createElement('input');
                btn.type = "button";
                btn.className = "btn";
                btn.value = "Upload Document";
                btn.onclick = (function () {
                    return function () {
                        //Todo open file chooser that does upload
                        console.log("button clicked");
                    }
                });
                urlCell.appendChild(btn);
            }
            else {
                var link = document.createElement("a");
                //link.setAttribute("href", array[i].url, "download", array[i].url);
                link.setAttribute("href", array[i].url);

                //link.className = "someCSSclass";

                var linkText = document.createTextNode(array[i].url);
                link.appendChild(linkText);

                // Add the link to the previously created TableCell.
                urlCell.appendChild(link);
            }

            row.appendChild(statusCell);
            row.appendChild(nameCell);
            row.appendChild(urlCell);

            // add the row to the end of the table body
            tblBody.appendChild(row);
        }

        // put the <tbody> in the <table>
        tbl.appendChild(tblBody);
        // appends <table> into <body>
        document.getElementById("showData").appendChild(tbl);
    }



    window.onload = function () {
        xhr.send();
    }

</script>


<div class="col-md-6">
    <div class="container-fluid">
        <h1>View Paper Status</h1>
        <h2><span id="paperTitle"></span></h2>
        <h3><span id="paperOwner"></span></h3>

        <h3>Preferences</h3>
        <div id="preferencelist"></div>

        <h3>Proofreading Needs</h3>
        <div id="needlist"></div>

         <h3>Proofreaders</h3>
         <div id="showData"></div>

        <div>
            <a type="button" class="btn btn-primary" href="https://github.com/heroku/node-js-getting-started">Go to Account</a>
        </div>
    </div>
</div>


<div class="col-md-6">
    <div class="container">
        <div>
            <a type="button" class="btn btn-primary" href="https://github.com/heroku/node-js-getting-started">Download Paper</a>
        </div>
    </div>

    <div class="embed-responsive embed-responsive-4by3">
        <iframe id="paperIframe" class="embed-responsive-item" style="width: 100%; height:100%;"></iframe>
    </div>
</div>

</body>
</html>
